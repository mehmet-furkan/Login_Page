<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ödev Teslim Sistemi</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font Ailesi -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Modalların varsayılan olarak gizli olması için */
        .modal {
            display: none;
        }
        .modal-backdrop {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-600">
                Bilgisayar Bilimlerine Giriş - Ödev Sistemi
            </h1>
            <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-6 mt-4 sm:mt-0">
                <!-- Rol Değiştirici -->
                <div class="flex items-center space-x-4">
                    <span class="font-medium">Görünüm:</span>
                    <label class="flex items-center">
                        <input type="radio" name="role" value="student" class="form-radio text-blue-600" checked>
                        <span class="ml-2">Öğrenci</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="role" value="professor" class="form-radio text-blue-600">
                        <span class="ml-2">Öğretim Görevlisi</span>
                    </label>
                </div>
                <!-- Kullanıcı ID Göstergesi -->
                <div id="user-info" class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full hidden">
                    Kullanıcı ID: <span id="user-id" class="font-medium text-gray-700"></span>
                </div>
            </div>
        </nav>
    </header>

    <!-- Ana İçerik -->
    <main class="container mx-auto p-6">

        <!-- Yükleniyor... -->
        <div id="loading" class="text-center py-10">
            <p class="text-lg font-medium text-gray-600">Sistem yükleniyor...</p>
        </div>

        <!-- Ödev Listesi Alanı -->
        <div id="dashboard-content" class="hidden">
            <!-- Öğretmen Görünümü: Yeni Ödev Butonu -->
            <div id="professor-actions" class="professor-view hidden mb-6 text-right">
                <button id="show-create-assignment-modal" class="bg-blue-600 text-white font-medium py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                    Yeni Ödev Oluştur
                </button>
            </div>

            <!-- Ödev Listesi -->
            <div id="assignment-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Ödev kartları buraya JS ile eklenecek -->
            </div>
        </div>

    </main>

    <!-- 1. Yeni Ödev Oluşturma Modalı (Öğretmen) -->
    <div id="create-assignment-modal" class="modal fixed inset-0 z-50 overflow-auto">
        <div id="create-assignment-backdrop" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50"></div>
        <div class="relative p-8 bg-white w-full max-w-lg mx-auto mt-20 rounded-lg shadow-xl">
            <h3 class="text-2xl font-semibold mb-6">Yeni Ödev Oluştur</h3>
            <form id="create-assignment-form">
                <div class="mb-4">
                    <label for="assignment-title" class="block text-sm font-medium text-gray-700 mb-1">Ödev Başlığı</label>
                    <input type="text" id="assignment-title" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="assignment-desc" class="block text-sm font-medium text-gray-700 mb-1">Açıklama</label>
                    <textarea id="assignment-desc" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div class="mb-6">
                    <label for="assignment-due-date" class="block text-sm font-medium text-gray-700 mb-1">Teslim Tarihi</label>
                    <input type="date" id="assignment-due-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-create-assignment" class="bg-gray-200 text-gray-700 font-medium py-2 px-6 rounded-lg hover:bg-gray-300 transition duration-300">İptal</button>
                    <button type="submit" class="bg-blue-600 text-white font-medium py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">Oluştur</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 2. Ödev Teslim Modalı (Öğrenci) -->
    <div id="submit-assignment-modal" class="modal fixed inset-0 z-50 overflow-auto">
        <div id="submit-assignment-backdrop" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50"></div>
        <div class="relative p-8 bg-white w-full max-w-lg mx-auto mt-20 rounded-lg shadow-xl">
            <h3 class="text-2xl font-semibold mb-2">Ödev Teslim Et</h3>
            <p id="submit-modal-title" class="text-lg text-gray-600 mb-6"></p>
            <form id="submit-assignment-form" data-assignment-id="">
                <div class="mb-4">
                    <label for="student-name" class="block text-sm font-medium text-gray-700 mb-1">Adınız Soyadınız</label>
                    <input type="text" id="student-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="submission-file" class="block text-sm font-medium text-gray-700 mb-1">Ödev Dosyası (.zip, .pdf, .jpg, vb.)</label>
                    <input type="file" id="submission-file" class="w-full text-sm text-gray-500 border border-gray-300 rounded-lg cursor-pointer focus:outline-none
                                file:mr-4 file:py-2 file:px-4 file:rounded-l-lg file:border-0
                                file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700
                                hover:file:bg-blue-100" required>
                    <p class="text-xs text-gray-500 mt-1">Lütfen dosyanızı seçin. Yüklendikten sonra hocanız erişebilecektir.</p>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-submit-assignment" class="bg-gray-200 text-gray-700 font-medium py-2 px-6 rounded-lg hover:bg-gray-300 transition duration-300">İptal</button>
                    <button type="submit" id="submit-assignment-btn" class="bg-green-600 text-white font-medium py-2 px-6 rounded-lg shadow-md hover:bg-green-700 transition duration-300 w-32 text-center">
                        Teslim Et
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 3. Teslimleri Görüntüleme Modalı (Öğretmen) -->
    <div id="view-submissions-modal" class="modal fixed inset-0 z-50 overflow-auto">
        <div id="view-submissions-backdrop" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50"></div>
        <div class="relative p-8 bg-white w-full max-w-2xl mx-auto mt-20 rounded-lg shadow-xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-semibold">Ödev Teslimleri</h3>
                <button type="button" id="close-view-submissions" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <p id="view-modal-title" class="text-lg text-gray-600 mb-6"></p>
            <div class="max-h-96 overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Öğrenci Adı</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Öğrenci ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teslim Linki</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teslim Zamanı</th>
                        </tr>
                    </thead>
                    <tbody id="submissions-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Teslimler buraya eklenecek -->
                    </tbody>
                </table>
                <div id="no-submissions" class="text-center py-6 text-gray-500 hidden">
                    Henüz teslim yapan öğrenci yok.
                </div>
            </div>
        </div>
    </div>

    <!-- 4. Silme Onay Modalı (Öğretmen) -->
    <div id="delete-confirm-modal" class="modal fixed inset-0 z-50 overflow-auto">
        <div id="delete-confirm-backdrop" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50"></div>
        <div class="relative p-8 bg-white w-full max-w-md mx-auto mt-20 rounded-lg shadow-xl">
            <h3 class="text-2xl font-semibold mb-4 text-red-600">Ödevi Sil</h3>
            <p id="delete-confirm-text" class="text-gray-700 mb-6">Bu ödevi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.</p>
            <div class="flex justify-end space-x-4">
                <button type="button" id="cancel-delete" class="bg-gray-200 text-gray-700 font-medium py-2 px-6 rounded-lg hover:bg-gray-300 transition duration-300">İptal</button>
                <button type="button" id="confirm-delete-btn" class="bg-red-600 text-white font-medium py-2 px-6 rounded-lg shadow-md hover:bg-red-700 transition duration-300">
                    Evet, Sil
                </button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // Firebase ve Firestore modüllerini import et
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            deleteDoc,
            collection, 
            onSnapshot, 
            query,
            serverTimestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Global Değişkenler ---
        let app, db, auth, storage;
        let userId = null;
        let currentView = 'student'; // Varsayılan görünüm
        let assignments = []; // Ödevleri lokal olarak sakla
        let submissions = []; // Teslimleri lokal olarak sakla

        // --- Firebase Konfigürasyonu ---
        // LÜTFEN DİKKAT:
        // Buraya Firebase projenizden (nam5 lokasyonu ile oluşturduğunuz)
        // aldığınız KENDİ config bilgilerinizi yapıştırın.
        const firebaseConfig = {
            apiKey: "SENIN-API-KEYIN",
            authDomain: "SENIN-AUTH-DOMAININ.firebaseapp.com",
            projectId: "SENIN-PROJE-IDN",
            storageBucket: "SENIN-STORAGE-BUCKETIN.appspot.com",
            messagingSenderId: "SENIN-MESSAGING-SENDER-IDN",
            appId: "SENIN-APP-IDN"
        };
        // --- BİTİŞ ---

        const appId = firebaseConfig.appId; // appId'yi doğrudan config'den al

        // --- Koleksiyon Yolları ---
        // VS Code'da lokal test için basit yollar (Firebase kurallarınız 'allow read, write: if true;' olmalı)
        const assignmentsCollectionPath = `assignments`;
        const submissionsCollectionPath = `submissions`;

        // --- DOM Elementleri ---
        const loadingEl = document.getElementById('loading');
        const dashboardContentEl = document.getElementById('dashboard-content');
        const assignmentListEl = document.getElementById('assignment-list');
        const userInfoEl = document.getElementById('user-info');
        const userIdEl = document.getElementById('user-id');
        const professorActionsEl = document.getElementById('professor-actions');

        // Modal Elementleri
        const createAssignmentModal = document.getElementById('create-assignment-modal');
        const submitAssignmentModal = document.getElementById('submit-assignment-modal');
        const viewSubmissionsModal = document.getElementById('view-submissions-modal');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal'); // YENİ
        const submissionsTableBody = document.getElementById('submissions-table-body');
        const noSubmissionsEl = document.getElementById('no-submissions');

        // --- Modal Kontrol Fonksiyonları ---

        function showModal(modal) {
            modal.style.display = 'block';
            modal.querySelector('.modal-backdrop').style.display = 'block';
        }

        function hideModal(modal) {
            modal.style.display = 'none';
            modal.querySelector('.modal-backdrop').style.display = 'none';
        }

        // --- Firebase Başlatma ---

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app); // Storage'ı başlat
                
                // Firestore log seviyesini ayarla (debug için)
                setLogLevel('debug');

                console.log("Firebase başlatıldı.");

                // Kullanıcı oturum durumunu dinle
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // Kullanıcı oturum açtı
                        userId = user.uid;
                        console.log("Kullanıcı doğrulandı, ID:", userId);
                        userIdEl.textContent = userId.substring(0, 8) + '...'; // ID'nin bir kısmını göster
                        userInfoEl.classList.remove('hidden');

                        // Verileri yükle
                        await loadData();
                        
                    } else {
                        // Kullanıcı oturumu kapalı, anonim olarak aç
                        console.log("Kullanıcı oturumu yok. VS Code'da anonim oturum açılıyor...");
                        // Lokal geliştirme için her zaman anonim olarak oturum aç
                        await signInAnonymously(auth);
                    }
                });

            } catch (error) {
                console.error("Firebase başlatma hatası:", error);
                loadingEl.textContent = "Sistem yüklenirken bir hata oluştu.";
            }
        }

        // --- Veri Yükleme (Real-time) ---

        async function loadData() {
            if (!db || !userId) {
                console.warn("Veri yüklenemedi: DB veya Kullanıcı ID'si eksik.");
                return;
            }

            console.log("Veriler yükleniyor...");
            loadingEl.style.display = 'none';
            dashboardContentEl.classList.remove('hidden');

            // 1. Ödevleri dinle
            const assignmentsQuery = query(collection(db, assignmentsCollectionPath));
            onSnapshot(assignmentsQuery, (snapshot) => {
                console.log("Ödevler güncellendi.");
                assignments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Tarihe göre sırala (en yeni en üstte)
                assignments.sort((a, b) => new Date(b.dueDate) - new Date(a.dueDate));
                renderDashboard();
            }, (error) => {
                console.error("Ödevleri dinlerken hata:", error);
            });

            // 2. Teslimleri dinle
            const submissionsQuery = query(collection(db, submissionsCollectionPath));
            onSnapshot(submissionsQuery, (snapshot) => {
                console.log("Teslimler güncellendi.");
                submissions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDashboard(); // Teslim durumu değişince arayüzü güncelle
            }, (error) => {
                console.error("Teslimleri dinlerken hata:", error);
            });
        }

        // --- Arayüzü Çizdirme (Render) Fonksiyonları ---

        function renderDashboard() {
            if (!dashboardContentEl) return;

            // 1. Rol görünürlüğünü ayarla
            const professorViews = document.querySelectorAll('.professor-view');
            const studentViews = document.querySelectorAll('.student-view');

            if (currentView === 'professor') {
                professorActionsEl.classList.remove('hidden');
                professorViews.forEach(el => el.style.display = 'block');
                studentViews.forEach(el => el.style.display = 'none');
            } else {
                professorActionsEl.classList.add('hidden');
                professorViews.forEach(el => el.style.display = 'none');
                studentViews.forEach(el => el.style.display = 'block');
            }

            // 2. Ödev listesini çizdir
            renderAssignments();
        }

        function renderAssignments() {
            assignmentListEl.innerHTML = ''; // Listeyi temizle

            if (assignments.length === 0) {
                assignmentListEl.innerHTML = `<p class="text-gray-500 col-span-full text-center">Henüz oluşturulmuş bir ödev yok.</p>`;
                return;
            }

            assignments.forEach(assignment => {
                const card = createAssignmentCard(assignment);
                assignmentListEl.appendChild(card);
            });
        }

        function createAssignmentCard(assignment) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-lg p-6 flex flex-col justify-between transition-shadow duration-300 hover:shadow-xl';

            // Öğrencinin bu ödeve teslimat yapıp yapmadığını kontrol et
            const mySubmission = submissions.find(s => s.studentId === userId && s.assignmentId === assignment.id);
            const formattedDueDate = new Date(assignment.dueDate).toLocaleDateString('tr-TR', { day: '2-digit', month: 'long', year: 'numeric' });

            let statusHTML = '';
            if (mySubmission) {
                // Öğrenci teslim etmiş
                statusHTML = `
                    <div class="student-view mt-4 pt-4 border-t border-gray-100">
                        <span class="text-sm font-medium text-green-600 bg-green-100 px-3 py-1 rounded-full">
                            Teslim Edildi
                        </span>
                        <p class="text-xs text-gray-500 mt-2">Teslim Edilen Dosya: 
                            <a href="${mySubmission.submissionLink}" target="_blank" class="text-blue-500 hover:underline">${mySubmission.fileName || 'Dosya Linki'}</a>
                        </p>
                    </div>
                `;
            } else {
                // Öğrenci teslim etmemiş
                statusHTML = `
                    <div class="student-view mt-4 pt-4 border-t border-gray-100 text-right">
                        <button class="submit-btn bg-blue-500 text-white font-medium py-2 px-5 rounded-lg hover:bg-blue-600 transition duration-300" 
                                data-id="${assignment.id}" 
                                data-title="${assignment.title}">
                            Teslim Et
                        </button>
                    </div>
                `;
            }

            const professorHTML = `
                <div class="professor-view mt-4 pt-4 border-t border-gray-100 flex justify-between items-center">
                    <button class="view-submissions-btn text-sm text-blue-600 font-medium hover:underline" 
                            data-id="${assignment.id}" 
                            data-title="${assignment.title}">
                        Teslimleri Gör
                    </button>
                    <button class="delete-assignment-btn text-sm text-red-500 font-medium hover:text-red-700"
                            data-id="${assignment.id}">
                        Sil
                    </button>
                </div>
            `;

            card.innerHTML = `
                <div>
                    <h3 class="text-xl font-semibold text-gray-800">${assignment.title}</h3>
                    <p class="text-sm text-gray-500 mt-1 mb-3">Son Teslim: ${formattedDueDate}</p>
                    <p class="text-gray-700 text-sm">${assignment.description || 'Açıklama yok.'}</p>
                </div>
                <div>
                    ${statusHTML}
                    ${professorHTML}
                </div>
            `;
            
            // Render sonrası rol görünürlüğünü tekrar ayarla
            if (currentView === 'professor') {
                card.querySelector('.professor-view').style.display = 'flex';
                card.querySelector('.student-view').style.display = 'none';
            } else {
                card.querySelector('.professor-view').style.display = 'none';
                card.querySelector('.student-view').style.display = 'block';
            }

            return card;
        }

        // --- Event Listeners ---

        function setupEventListeners() {
            // Rol değiştirme
            document.querySelectorAll('input[name="role"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    currentView = e.target.value;
                    renderDashboard();
                });
            });

            // --- Modal Gösterme Butonları ---

            // Yeni Ödev Oluştur
            document.getElementById('show-create-assignment-modal').addEventListener('click', () => {
                showModal(createAssignmentModal);
            });

            // Ödev Teslim Et (Dinamik olarak eklenen butonlar için event delegation)
            assignmentListEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('submit-btn')) {
                    const assignmentId = e.target.dataset.id;
                    const assignmentTitle = e.target.dataset.title;
                    document.getElementById('submit-modal-title').textContent = assignmentTitle;
                    document.getElementById('submit-assignment-form').dataset.assignmentId = assignmentId;
                    showModal(submitAssignmentModal);
                }

                // Teslimleri Gör (Öğretmen)
                if (e.target.classList.contains('view-submissions-btn')) {
                    const assignmentId = e.target.dataset.id;
                    const assignmentTitle = e.target.dataset.title;
                    document.getElementById('view-modal-title').textContent = `${assignmentTitle} için teslimler:`;
                    populateSubmissionsTable(assignmentId);
                    showModal(viewSubmissionsModal);
                }

                // Ödevi Sil (Öğretmen)
                if (e.target.classList.contains('delete-assignment-btn')) {
                    const assignmentId = e.target.dataset.id;
                    const assignmentTitle = e.target.closest('.bg-white').querySelector('h3').textContent;
                    
                    // Onay modalını göster
                    document.getElementById('delete-confirm-text').textContent = `"${assignmentTitle}" başlıklı ödevi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.`;
                    // Silme butonuna ID'yi ata
                    document.getElementById('confirm-delete-btn').dataset.id = assignmentId;
                    showModal(deleteConfirmModal);
                }
            });

            // --- Modal Kapatma Butonları ---
            document.getElementById('cancel-create-assignment').addEventListener('click', () => hideModal(createAssignmentModal));
            document.getElementById('create-assignment-backdrop').addEventListener('click', () => hideModal(createAssignmentModal));
            
            document.getElementById('cancel-submit-assignment').addEventListener('click', () => hideModal(submitAssignmentModal));
            document.getElementById('submit-assignment-backdrop').addEventListener('click', () => hideModal(submitAssignmentModal));

            document.getElementById('close-view-submissions').addEventListener('click', () => hideModal(viewSubmissionsModal));
            document.getElementById('view-submissions-backdrop').addEventListener('click', () => hideModal(viewSubmissionsModal));

            // YENİ - Silme Onay Modalı Kapatma
            document.getElementById('cancel-delete').addEventListener('click', () => hideModal(deleteConfirmModal));
            document.getElementById('delete-confirm-backdrop').addEventListener('click', () => hideModal(deleteConfirmModal));


            // --- Form Gönderme İşlemleri ---

            // Yeni Ödev Oluştur Formu
            document.getElementById('create-assignment-form').addEventListener('submit', handleCreateAssignment);

            // Ödev Teslim Formu
            document.getElementById('submit-assignment-form').addEventListener('submit', handleSubmitAssignment);

            // YENİ - Ödevi Silme Onayı
            document.getElementById('confirm-delete-btn').addEventListener('click', (e) => {
                const assignmentId = e.target.dataset.id;
                if (assignmentId) {
                    handleDeleteAssignment(assignmentId);
                }
            });
        }

        // --- Teslim Tablosunu Doldurma ---
        function populateSubmissionsTable(assignmentId) {
            submissionsTableBody.innerHTML = '';
            
            const relevantSubmissions = submissions.filter(s => s.assignmentId === assignmentId);

            if (relevantSubmissions.length === 0) {
                noSubmissionsEl.classList.remove('hidden');
                return;
            }
            
            noSubmissionsEl.classList.add('hidden');
            
            relevantSubmissions.forEach(sub => {
                const timestamp = sub.submissionTime?.toDate ? sub.submissionTime.toDate() : new Date();
                const formattedTime = timestamp.toLocaleString('tr-TR');

                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sub.studentName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sub.studentId.substring(0, 8)}...</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">
                            <a href="${sub.submissionLink}" target="_blank" class="hover:underline">${sub.fileName || 'Dosyayı İndir'}</a>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formattedTime}</td>
                    </tr>
                `;
                submissionsTableBody.innerHTML += row;
            });
        }


        // --- Firestore Eylem Fonksiyonları ---

        // (Öğretmen) Yeni Ödev Oluştur
        async function handleCreateAssignment(e) {
            e.preventDefault();
            const title = document.getElementById('assignment-title').value;
            const description = document.getElementById('assignment-desc').value;
            const dueDate = document.getElementById('assignment-due-date').value;

            if (!title || !dueDate) {
                console.error("Başlık ve tarih zorunludur.");
                return;
            }

            try {
                await addDoc(collection(db, assignmentsCollectionPath), {
                    title: title,
                    description: description,
                    dueDate: dueDate,
                    createdAt: serverTimestamp()
                });
                console.log("Ödev oluşturuldu.");
                hideModal(createAssignmentModal);
                e.target.reset(); // Formu temizle
            } catch (error) {
                console.error("Ödev oluşturma hatası: ", error);
            }
        }
        
        // (Öğretmen) Ödevi Sil
        async function handleDeleteAssignment(assignmentId) {
            console.log(`Ödev siliniyor: ${assignmentId}`);
            try {
                await deleteDoc(doc(db, assignmentsCollectionPath, assignmentId));
                console.log("Ödev silindi.");
                hideModal(deleteConfirmModal); // Onay modalını kapat
                // Not: Bu işlem, ödeve ait teslimleri silmez. 
                // Gerekirse, teslimleri de silmek için ek bir fonksiyon yazılmalıdır.
            } catch (error) {
                console.error("Ödev silme hatası: ", error);
            }
        }

        // (Öğrenci) Ödev Teslim Et
        async function handleSubmitAssignment(e) {
            e.preventDefault();
            const assignmentId = e.target.dataset.assignmentId;
            const studentName = document.getElementById('student-name').value;
            const fileInput = document.getElementById('submission-file');
            const file = fileInput.files[0];
            
            const submitBtn = document.getElementById('submit-assignment-btn');

            if (!assignmentId || !studentName || !file) {
                console.error("Tüm alanlar ve dosya seçimi zorunludur.");
                return;
            }

            // Butonu yükleniyor durumuna getir
            submitBtn.disabled = true;
            submitBtn.textContent = 'Yükleniyor...';

            try {
                // 1. Dosyayı Firebase Storage'a yükle
                console.log("Dosya yükleniyor...");
                // Benzersiz bir dosya yolu oluştur (Lokal test için)
                const filePath = `submissions/${assignmentId}/${userId}/${file.name}`;
                const fileRef = ref(storage, filePath);
                
                const uploadResult = await uploadBytes(fileRef, file);
                console.log("Dosya yüklendi:", uploadResult);

                // 2. Yüklenen dosyanın indirme URL'sini al
                const downloadURL = await getDownloadURL(uploadResult.ref);
                console.log("Dosya URL'si:", downloadURL);

                // 3. Dosya linkini Firestore'a kaydet (submissionLink olarak)
                await addDoc(collection(db, submissionsCollectionPath), {
                    assignmentId: assignmentId,
                    studentId: userId,
                    studentName: studentName,
                    submissionLink: downloadURL, // Burası artık Storage linki
                    fileName: file.name, // Dosya adını da kaydedelim
                    submissionTime: serverTimestamp()
                });
                
                console.log("Ödev teslim edildi.");
                hideModal(submitAssignmentModal);
                e.target.reset(); // Formu temizle
            } catch (error) {
                console.error("Ödev teslim etme hatası (Yükleme veya Firestore): ", error);
            } finally {
                // Butonu tekrar aktif hale getir
                submitBtn.disabled = false;
                submitBtn.textContent = 'Teslim Et';
            }
        }


        // --- Sayfa Yüklendiğinde Başlat ---
        window.onload = () => {
            initFirebase();
            setupEventListeners();
        };

    </script>
</body>
</html>


